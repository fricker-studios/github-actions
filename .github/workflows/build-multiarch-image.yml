name: Build Multiarch Image

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the Docker image to build'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to the Dockerfile (used for both architectures unless overridden)'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Build context path (used for both architectures unless overridden)'
        required: false
        type: string
        default: '.'
      build_args:
        description: 'Build arguments (newline-separated KEY=VALUE pairs, used for both architectures unless overridden)'
        required: false
        type: string
        default: ''
      arm_dockerfile_path:
        description: 'Path to the Dockerfile for ARM build (overrides dockerfile_path for ARM)'
        required: false
        type: string
        default: ''
      arm_context:
        description: 'Build context path for ARM build (overrides context for ARM)'
        required: false
        type: string
        default: ''
      arm_build_args:
        description: 'Build arguments for ARM build (newline-separated KEY=VALUE pairs, overrides build_args for ARM)'
        required: false
        type: string
        default: ''
      amd_dockerfile_path:
        description: 'Path to the Dockerfile for AMD build (overrides dockerfile_path for AMD)'
        required: false
        type: string
        default: ''
      amd_context:
        description: 'Build context path for AMD build (overrides context for AMD)'
        required: false
        type: string
        default: ''
      amd_build_args:
        description: 'Build arguments for AMD build (newline-separated KEY=VALUE pairs, overrides build_args for AMD)'
        required: false
        type: string
        default: ''
      push:
        description: 'Whether to push the image to registry'
        required: false
        type: boolean
        default: false
      registry:
        description: 'Docker registry URL (e.g., ghcr.io, registry.example.com). Defaults to Docker Hub if not specified'
        required: false
        type: string
        default: ''
      tags:
        description: 'Additional tags for the image (newline-separated)'
        required: false
        type: string
        default: ''
      download_artifacts:
        description: 'Whether to download build artifacts before building'
        required: false
        type: boolean
        default: false
      artifact_name:
        description: 'Name of the artifact to download (if download_artifacts is true)'
        required: false
        type: string
        default: ''
      artifact_path:
        description: 'Path where artifact contents should be moved (relative to workspace root). If empty, contents will be moved to workspace root.'
        required: false
        type: string
        default: '.'
    secrets:
      registry_username:
        description: 'Docker registry username'
        required: false
      registry_password:
        description: 'Docker registry password'
        required: false
    outputs:
      image_name:
        description: 'Image name without tag'
        value: ${{ jobs.create-manifest.outputs.image_name }}
      image_tag:
        description: 'Short image tag (e.g., commit-sha or first custom tag)'
        value: ${{ jobs.create-manifest.outputs.image_tag }}
      image_fullname:
        description: 'Full image name with tag (image_name:image_tag)'
        value: ${{ jobs.create-manifest.outputs.image_fullname }}
      digest:
        description: 'Image digest'
        value: ${{ jobs.create-manifest.outputs.digest }}

jobs:
  build-arm:
    uses: fricker-studios/github-actions/.github/workflows/build-arm-image.yml@main
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.arm_dockerfile_path != '' && inputs.arm_dockerfile_path || inputs.dockerfile_path }}
      context: ${{ inputs.arm_context != '' && inputs.arm_context || inputs.context }}
      build_args: ${{ inputs.arm_build_args != '' && inputs.arm_build_args || inputs.build_args }}
      push: ${{ inputs.push }}
      registry: ${{ inputs.registry }}
      tags: ${{ inputs.tags }}
      download_artifacts: ${{ inputs.download_artifacts }}
      artifact_name: ${{ inputs.artifact_name }}
      artifact_path: ${{ inputs.artifact_path }}
    secrets:
      registry_username: ${{ secrets.registry_username }}
      registry_password: ${{ secrets.registry_password }}

  build-amd:
    uses: fricker-studios/github-actions/.github/workflows/build-amd-image.yml@main
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.amd_dockerfile_path != '' && inputs.amd_dockerfile_path || inputs.dockerfile_path }}
      context: ${{ inputs.amd_context != '' && inputs.amd_context || inputs.context }}
      build_args: ${{ inputs.amd_build_args != '' && inputs.amd_build_args || inputs.build_args }}
      push: ${{ inputs.push }}
      registry: ${{ inputs.registry }}
      tags: ${{ inputs.tags }}
      download_artifacts: ${{ inputs.download_artifacts }}
      artifact_name: ${{ inputs.artifact_name }}
      artifact_path: ${{ inputs.artifact_path }}
    secrets:
      registry_username: ${{ secrets.registry_username }}
      registry_password: ${{ secrets.registry_password }}

  create-manifest:
    name: Create and Push Multiarch Manifest
    needs: [build-arm, build-amd]
    runs-on: [self-hosted]
    timeout-minutes: 10
    outputs:
      image_name: ${{ steps.output.outputs.image_name }}
      image_tag: ${{ steps.output.outputs.image_tag }}
      image_fullname: ${{ steps.output.outputs.image_fullname }}
      digest: ${{ steps.manifest.outputs.digest }}

    steps:
      - name: Login to Docker Registry
        if: inputs.push == true && inputs.registry != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}

      - name: Prepare manifest tags
        id: prepare-tags
        run: |
          MANIFEST_TAGS="${{ inputs.image_name }}:${{ github.sha }}"
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                MANIFEST_TAGS="$MANIFEST_TAGS ${{ inputs.image_name }}:$tag"
              fi
            done <<< "${{ inputs.tags }}"
          fi
          echo "manifest_tags=$MANIFEST_TAGS" >> $GITHUB_OUTPUT
          echo "Manifest tags: $MANIFEST_TAGS"

      - name: Create and push multiarch manifest
        id: manifest
        if: inputs.push == true
        timeout-minutes: 8
        run: |
          echo "Using ARM image: ${{ needs.build-arm.outputs.image_fullname }}"
          echo "Using AMD image: ${{ needs.build-amd.outputs.image_fullname }}"
          echo ""

          # Create list of all tags to manifest
          TAGS=("${{ inputs.image_name }}:${{ github.sha }}")
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                TAGS+=("${{ inputs.image_name }}:$tag")
              fi
            done <<< "${{ inputs.tags }}"
          fi

          # Create and push manifest for each tag
          DIGEST=""
          for TAG in "${TAGS[@]}"; do
            echo "Creating manifest for: $TAG"
            docker manifest create --amend "$TAG" \
              ${{ needs.build-arm.outputs.image_fullname }} \
              ${{ needs.build-amd.outputs.image_fullname }}
            docker manifest push "$TAG"

            # Get the digest from the first tag
            if [ -z "$DIGEST" ]; then
              if command -v jq &> /dev/null; then
                DIGEST=$(docker manifest inspect "$TAG" | jq -r '.manifests[0].digest')
              else
                DIGEST=$(docker manifest inspect "$TAG" | grep -oP '"digest":\s*"\K[^"]+' | head -1)
              fi
            fi
            echo "âœ… Pushed manifest: $TAG"
          done

          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… All multiarch manifests created and pushed successfully"
          echo "Primary tag: ${{ inputs.image_name }}:${{ github.sha }}"
          echo "Manifest digest: $DIGEST"

      - name: Create local manifest (no push)
        if: inputs.push == false
        run: |
          echo "âš ï¸  Manifest creation skipped (push=false)"
          echo "Would create manifest from:"
          echo "  - ARM: ${{ needs.build-arm.outputs.image_fullname }}"
          echo "  - AMD: ${{ needs.build-amd.outputs.image_fullname }}"

      - name: Output image information
        id: output
        run: |
          # Determine the short tag (first custom tag if provided, otherwise commit sha)
          SHORT_TAG="${{ github.sha }}"
          if [ -n "${{ inputs.tags }}" ]; then
            SHORT_TAG=$(echo "${{ inputs.tags }}" | head -n 1 | tr -d '[:space:]')
          fi
          
          echo "image_name=${{ inputs.image_name }}" >> $GITHUB_OUTPUT
          echo "image_tag=$SHORT_TAG" >> $GITHUB_OUTPUT
          echo "image_fullname=${{ inputs.image_name }}:$SHORT_TAG" >> $GITHUB_OUTPUT
          echo "âœ… Multiarch workflow completed"
          echo "Image Name: ${{ inputs.image_name }}"
          echo "Image Tag: $SHORT_TAG"
          echo "Full Image: ${{ inputs.image_name }}:$SHORT_TAG"
          echo "ARM digest: ${{ needs.build-arm.outputs.digest }}"
          echo "AMD digest: ${{ needs.build-amd.outputs.digest }}"
          
          # Add comprehensive summary to GitHub Step Summary
          echo "# ðŸŽ‰ Multiarch Image Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“¦ Manifest Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Primary Tag | \`${{ inputs.image_name }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.manifest.outputs.digest }}" ]; then
            echo "| Manifest Digest | \`${{ steps.manifest.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Pushed | ${{ inputs.push }} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.registry }}" ]; then
            echo "| Registry | ${{ inputs.registry }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ—ï¸ Architecture-Specific Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Image Tag | Digest |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| ARM64 | \`${{ needs.build-arm.outputs.image_fullname }}\` | \`${{ needs.build-arm.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| AMD64 | \`${{ needs.build-amd.outputs.image_fullname }}\` | \`${{ needs.build-amd.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ inputs.tags }}" ]; then
            echo "## ðŸ·ï¸ All Tags Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Tag | Architectures |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| \`${{ inputs.image_name }}:${{ github.sha }}\` | arm64, amd64 |" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                echo "| \`${{ inputs.image_name }}:$tag\` | arm64, amd64 |" >> $GITHUB_STEP_SUMMARY
              fi
            done <<< "${{ inputs.tags }}"
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ inputs.build_args }}" ] || [ -n "${{ inputs.arm_build_args }}" ] || [ -n "${{ inputs.amd_build_args }}" ]; then
            echo "## âš™ï¸ Build Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ inputs.build_args }}" ]; then
              echo "**Common Build Args:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${{ inputs.build_args }}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ inputs.arm_build_args }}" ]; then
              echo "**ARM-specific Build Args:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${{ inputs.arm_build_args }}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ inputs.amd_build_args }}" ]; then
              echo "**AMD-specific Build Args:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${{ inputs.amd_build_args }}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.push }}" == "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** Images were built but not pushed (push=false)" >> $GITHUB_STEP_SUMMARY
          fi
