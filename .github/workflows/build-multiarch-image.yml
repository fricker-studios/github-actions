name: Build Multiarch Image

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the Docker image to build'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to the Dockerfile (used for both architectures unless overridden)'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Build context path (used for both architectures unless overridden)'
        required: false
        type: string
        default: '.'
      build_args:
        description: 'Build arguments (comma-separated KEY=VALUE pairs, used for both architectures unless overridden)'
        required: false
        type: string
        default: ''
      arm_dockerfile_path:
        description: 'Path to the Dockerfile for ARM build (overrides dockerfile_path for ARM)'
        required: false
        type: string
        default: ''
      arm_context:
        description: 'Build context path for ARM build (overrides context for ARM)'
        required: false
        type: string
        default: ''
      arm_build_args:
        description: 'Build arguments for ARM build (overrides build_args for ARM)'
        required: false
        type: string
        default: ''
      amd_dockerfile_path:
        description: 'Path to the Dockerfile for AMD build (overrides dockerfile_path for AMD)'
        required: false
        type: string
        default: ''
      amd_context:
        description: 'Build context path for AMD build (overrides context for AMD)'
        required: false
        type: string
        default: ''
      amd_build_args:
        description: 'Build arguments for AMD build (overrides build_args for AMD)'
        required: false
        type: string
        default: ''
      push:
        description: 'Whether to push the image to registry'
        required: false
        type: boolean
        default: false
      tags:
        description: 'Additional tags for the image (newline-separated)'
        required: false
        type: string
        default: ''
    secrets:
      registry_username:
        description: 'Docker registry username'
        required: false
      registry_password:
        description: 'Docker registry password'
        required: false
    outputs:
      image_tag:
        description: 'Full image tag that was built'
        value: ${{ jobs.create-manifest.outputs.image_tag }}
      digest:
        description: 'Image digest'
        value: ${{ jobs.create-manifest.outputs.digest }}

jobs:
  build-arm:
    uses: ./.github/workflows/build-arm-image.yml
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.arm_dockerfile_path != '' && inputs.arm_dockerfile_path || inputs.dockerfile_path }}
      context: ${{ inputs.arm_context != '' && inputs.arm_context || inputs.context }}
      build_args: ${{ inputs.arm_build_args != '' && inputs.arm_build_args || inputs.build_args }}
      push: ${{ inputs.push }}
      tags: ${{ inputs.tags }}
    secrets:
      registry_username: ${{ secrets.registry_username }}
      registry_password: ${{ secrets.registry_password }}

  build-amd:
    uses: ./.github/workflows/build-amd-image.yml
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.amd_dockerfile_path != '' && inputs.amd_dockerfile_path || inputs.dockerfile_path }}
      context: ${{ inputs.amd_context != '' && inputs.amd_context || inputs.context }}
      build_args: ${{ inputs.amd_build_args != '' && inputs.amd_build_args || inputs.build_args }}
      push: ${{ inputs.push }}
      tags: ${{ inputs.tags }}
    secrets:
      registry_username: ${{ secrets.registry_username }}
      registry_password: ${{ secrets.registry_password }}

  create-manifest:
    needs: [build-arm, build-amd]
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.output.outputs.image_tag }}
      digest: ${{ steps.manifest.outputs.digest }}

    steps:
      - name: Login to Docker Registry
        if: inputs.push == true && secrets.registry_username != '' && secrets.registry_password != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}

      - name: Prepare manifest tags
        id: prepare-tags
        run: |
          MANIFEST_TAGS="${{ inputs.image_name }}:${{ github.sha }}"
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                MANIFEST_TAGS="$MANIFEST_TAGS ${{ inputs.image_name }}:$tag"
              fi
            done <<< "${{ inputs.tags }}"
          fi
          echo "manifest_tags=$MANIFEST_TAGS" >> $GITHUB_OUTPUT
          echo "Manifest tags: $MANIFEST_TAGS"

      - name: Create and push multiarch manifest
        id: manifest
        if: inputs.push == true
        run: |
          echo "Using ARM image: ${{ needs.build-arm.outputs.image_tag }}"
          echo "Using AMD image: ${{ needs.build-amd.outputs.image_tag }}"
          echo ""

          # Create list of all tags to manifest
          TAGS=("${{ inputs.image_name }}:${{ github.sha }}")
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                TAGS+=("${{ inputs.image_name }}:$tag")
              fi
            done <<< "${{ inputs.tags }}"
          fi

          # Create and push manifest for each tag
          DIGEST=""
          for TAG in "${TAGS[@]}"; do
            echo "Creating manifest for: $TAG"
            docker manifest create "$TAG" \
              ${{ needs.build-arm.outputs.image_tag }} \
              ${{ needs.build-amd.outputs.image_tag }}
            docker manifest push "$TAG"

            # Get the digest from the first tag
            if [ -z "$DIGEST" ]; then
              if command -v jq &> /dev/null; then
                DIGEST=$(docker manifest inspect "$TAG" | jq -r '.manifests[0].digest')
              else
                DIGEST=$(docker manifest inspect "$TAG" | grep -oP '"digest":\s*"\K[^"]+' | head -1)
              fi
            fi
            echo "✅ Pushed manifest: $TAG"
          done

          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "✅ All multiarch manifests created and pushed successfully"
          echo "Primary tag: ${{ inputs.image_name }}:${{ github.sha }}"
          echo "Manifest digest: $DIGEST"

      - name: Create local manifest (no push)
        if: inputs.push == false
        run: |
          echo "⚠️  Manifest creation skipped (push=false)"
          echo "Would create manifest from:"
          echo "  - ARM: ${{ needs.build-arm.outputs.image_tag }}"
          echo "  - AMD: ${{ needs.build-amd.outputs.image_tag }}"

      - name: Output image information
        id: output
        run: |
          echo "image_tag=${{ inputs.image_name }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "✅ Multiarch workflow completed"
          echo "Image: ${{ inputs.image_name }}:${{ github.sha }}"
          echo "ARM digest: ${{ needs.build-arm.outputs.digest }}"
          echo "AMD digest: ${{ needs.build-amd.outputs.digest }}"
