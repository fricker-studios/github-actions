name: Build Multiarch Image

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the Docker image to build'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to the Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      build_args:
        description: 'Build arguments (comma-separated KEY=VALUE pairs)'
        required: false
        type: string
        default: ''
      push:
        description: 'Whether to push the image to registry'
        required: false
        type: boolean
        default: false
      tags:
        description: 'Additional tags for the image (newline-separated)'
        required: false
        type: string
        default: ''
    secrets:
      registry_username:
        description: 'Docker registry username'
        required: false
      registry_password:
        description: 'Docker registry password'
        required: false
    outputs:
      image_tag:
        description: 'Full image tag that was built'
        value: ${{ jobs.create-manifest.outputs.image_tag }}
      digest:
        description: 'Image digest'
        value: ${{ jobs.create-manifest.outputs.digest }}

jobs:
  build-arm:
    uses: ./.github/workflows/build-arm-image.yml
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.dockerfile_path }}
      context: ${{ inputs.context }}
      build_args: ${{ inputs.build_args }}
      push: ${{ inputs.push }}
      tags: ${{ inputs.tags }}
    secrets:
      registry_username: ${{ secrets.registry_username }}
      registry_password: ${{ secrets.registry_password }}

  build-amd:
    uses: ./.github/workflows/build-amd-image.yml
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.dockerfile_path }}
      context: ${{ inputs.context }}
      build_args: ${{ inputs.build_args }}
      push: ${{ inputs.push }}
      tags: ${{ inputs.tags }}
    secrets:
      registry_username: ${{ secrets.registry_username }}
      registry_password: ${{ secrets.registry_password }}

  create-manifest:
    needs: [build-arm, build-amd]
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.output.outputs.image_tag }}
      digest: ${{ steps.manifest.outputs.digest }}

    steps:
      - name: Login to Docker Registry
        if: inputs.push == true && secrets.registry_username != '' && secrets.registry_password != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}

      - name: Prepare manifest tags
        id: prepare-tags
        run: |
          MANIFEST_TAGS="${{ inputs.image_name }}:${{ github.sha }}"
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                MANIFEST_TAGS="$MANIFEST_TAGS ${{ inputs.image_name }}:$tag"
              fi
            done <<< "${{ inputs.tags }}"
          fi
          echo "manifest_tags=$MANIFEST_TAGS" >> $GITHUB_OUTPUT
          echo "Manifest tags: $MANIFEST_TAGS"

      - name: Create and push multiarch manifest
        id: manifest
        if: inputs.push == true
        run: |
          # Get the first manifest tag as the primary tag
          PRIMARY_TAG="${{ inputs.image_name }}:${{ github.sha }}"

          # Create manifest with ARM and AMD images
          docker manifest create $PRIMARY_TAG \
            ${{ needs.build-arm.outputs.image_tag }} \
            ${{ needs.build-amd.outputs.image_tag }}

          # Push the manifest
          docker manifest push $PRIMARY_TAG

          # Get the digest
          DIGEST=$(docker manifest inspect $PRIMARY_TAG | grep -oP '"digest":\s*"\K[^"]+' | head -1)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

          # Create and push additional tags if provided
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                TAG="${{ inputs.image_name }}:$tag"
                docker manifest create $TAG \
                  ${{ needs.build-arm.outputs.image_tag }} \
                  ${{ needs.build-amd.outputs.image_tag }}
                docker manifest push $TAG
                echo "✅ Pushed manifest: $TAG"
              fi
            done <<< "${{ inputs.tags }}"
          fi

          echo "✅ Multiarch manifest created and pushed successfully"
          echo "Primary tag: $PRIMARY_TAG"
          echo "Digest: $DIGEST"

      - name: Create local manifest (no push)
        if: inputs.push == false
        run: |
          echo "⚠️  Manifest creation skipped (push=false)"
          echo "Would create manifest from:"
          echo "  - ARM: ${{ needs.build-arm.outputs.image_tag }}"
          echo "  - AMD: ${{ needs.build-amd.outputs.image_tag }}"

      - name: Output image information
        id: output
        run: |
          echo "image_tag=${{ inputs.image_name }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "✅ Multiarch workflow completed"
          echo "Image: ${{ inputs.image_name }}:${{ github.sha }}"
          echo "ARM digest: ${{ needs.build-arm.outputs.digest }}"
          echo "AMD digest: ${{ needs.build-amd.outputs.digest }}"
