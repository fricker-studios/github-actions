name: Build ARM Image

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the Docker image to build'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to the Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      build_args:
        description: 'Build arguments (comma-separated KEY=VALUE pairs)'
        required: false
        type: string
        default: ''
      push:
        description: 'Whether to push the image to registry'
        required: false
        type: boolean
        default: false
      registry:
        description: 'Docker registry URL (e.g., ghcr.io, registry.example.com). Defaults to Docker Hub if not specified'
        required: false
        type: string
        default: ''
      tags:
        description: 'Additional tags for the image (newline-separated)'
        required: false
        type: string
        default: ''
      download_artifacts:
        description: 'Whether to download build artifacts before building'
        required: false
        type: boolean
        default: false
      artifact_name:
        description: 'Name of the artifact to download (if download_artifacts is true)'
        required: false
        type: string
        default: ''
      artifact_path:
        description: 'Path where artifact contents should be moved (relative to workspace root). If empty, contents will be moved to workspace root.'
        required: false
        type: string
        default: '.'
    secrets:
      registry_username:
        description: 'Docker registry username'
        required: false
      registry_password:
        description: 'Docker registry password'
        required: false
    outputs:
      image_name:
        description: 'Image name without tag'
        value: ${{ jobs.build-arm.outputs.image_name }}
      image_tag:
        description: 'Short image tag (e.g., commit-sha-arm64 or custom tag)'
        value: ${{ jobs.build-arm.outputs.image_tag }}
      image_fullname:
        description: 'Full image name with tag (image_name:image_tag)'
        value: ${{ jobs.build-arm.outputs.image_fullname }}
      digest:
        description: 'Image digest'
        value: ${{ jobs.build-arm.outputs.digest }}

jobs:
  build-arm:
    name: Build and Push ARM Image
    runs-on: [self-hosted, ARM64]
    timeout-minutes: 60
    outputs:
      image_name: ${{ steps.output.outputs.image_name }}
      image_tag: ${{ steps.output.outputs.image_tag }}
      image_fullname: ${{ steps.output.outputs.image_fullname }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        if: inputs.download_artifacts == true
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.artifact_path }}

      - name: Verify artifacts
        if: inputs.download_artifacts == true
        run: |
          echo "âœ… Artifacts downloaded to: ${{ inputs.artifact_path }}"
          echo ""
          echo "=== Workspace structure ==="
          ls -la
          echo ""
          if [ -d "frontend" ]; then
            echo "=== frontend/ contents ==="
            ls -la frontend/
            echo ""
            if [ -d "frontend/dist" ]; then
              echo "=== frontend/dist/ contents (first 20 items) ==="
              ls -la frontend/dist/ | head -20
            fi
          fi

      - name: Login to Docker Registry
        if: inputs.push == true && inputs.registry != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}

      - name: Prepare build args
        id: prepare-args
        run: |
          if [ -n "${{ inputs.build_args }}" ]; then
            echo "build_args<<EOF" >> $GITHUB_OUTPUT
            echo "${{ inputs.build_args }}" | tr ',' '\n' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "build_args=" >> $GITHUB_OUTPUT
          fi

      - name: Prepare tags
        id: prepare-tags
        run: |
          TAGS="${{ inputs.image_name }}:${{ github.sha }}-arm64"
          if [ -n "${{ inputs.tags }}" ]; then
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                TAGS="$TAGS,${{ inputs.image_name }}:$tag-arm64"
              fi
            done <<< "${{ inputs.tags }}"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Built tags: $TAGS"

      - name: Build and push ARM image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile_path }}
          platforms: linux/arm64
          push: ${{ inputs.push }}
          tags: ${{ steps.prepare-tags.outputs.tags }}
          build-args: ${{ steps.prepare-args.outputs.build_args }}
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image information
        id: output
        run: |
          echo "image_name=${{ inputs.image_name }}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ github.sha }}-arm64" >> $GITHUB_OUTPUT
          echo "image_fullname=${{ inputs.image_name }}:${{ github.sha }}-arm64" >> $GITHUB_OUTPUT
          echo "digest=${{ steps.build.outputs.digest }}" >> $GITHUB_OUTPUT
          echo "âœ… ARM64 image built successfully"
          echo "Image: ${{ inputs.image_name }}:${{ github.sha }}-arm64"
          echo "Digest: ${{ steps.build.outputs.digest }}"
          
          # Add to GitHub Step Summary
          echo "## ðŸ—ï¸ ARM64 Image Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ARM64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Primary Tag | \`${{ inputs.image_name }}:${{ github.sha }}-arm64\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed | ${{ inputs.push }} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.registry }}" ]; then
            echo "| Registry | ${{ inputs.registry }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ inputs.tags }}" ]; then
            echo "### Additional Tags" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                echo "- \`${{ inputs.image_name }}:$tag-arm64\`" >> $GITHUB_STEP_SUMMARY
              fi
            done <<< "${{ inputs.tags }}"
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ inputs.build_args }}" ]; then
            echo "### Build Arguments" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ inputs.build_args }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
