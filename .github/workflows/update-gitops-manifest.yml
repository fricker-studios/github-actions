name: Update Kustomization for GitOps Manifest

on:
  workflow_call:
    inputs:
      image_tag:
        description: 'The new image tag to set in the kustomization.yaml'
        required: true
        type: string
      gitops_repo:
        description: 'The GitOps repository to update'
        required: true
        type: string
      project_source_dir:
        description: 'The directory within the GitOps repo where the kustomization.yaml is located'
        required: true
        type: string
    secrets:
      GITOPS_ACCESS_TOKEN:
        description: 'Personal Access Token for accessing the GitOps repository'
        required: true

jobs:
  update-gitops-manifest:
    runs-on: [self-hosted]
    name: Update GitOps Manifest

    steps:
      - name: Initialize Summary
        run: |
          echo "## GitOps Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ inputs.gitops_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project Directory:** \`${{ inputs.project_source_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**New Image Tag:** \`${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Started:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Checkout gitops repo
        uses: actions/checkout@v4
        with:
            repository: ${{ inputs.gitops_repo }}
            token: ${{ secrets.GITOPS_ACCESS_TOKEN }}
            path: gitops

      - name: Update kustomization.yaml
        env:
            IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
            cd gitops/${{ inputs.project_source_dir }}
            echo "ðŸ“ Updating kustomization.yaml in ${{ inputs.project_source_dir }}"
            
            # Capture old content
            echo "### Before Update" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            grep "newTag:" kustomization.yaml >> $GITHUB_STEP_SUMMARY || echo "No newTag found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Update image tags
            sed -i "s|newTag: .*|newTag: $IMAGE_TAG|g" kustomization.yaml
            
            # Show updated content
            echo "### After Update" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            grep "newTag:" kustomization.yaml >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "âœ… Successfully updated kustomization.yaml"
            cat kustomization.yaml

      - name: Commit and push changes
        env:
            IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
            cd gitops
            echo "ðŸ“¤ Committing and pushing changes..."
            
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add ${{ inputs.project_source_dir }}/kustomization.yaml
            
            # Check if there are changes
            if git diff --cached --quiet; then
              echo "âš ï¸  No changes detected" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸  No changes to commit"
            else
              COMMIT_MSG="Update ${{ inputs.project_source_dir }} images to $IMAGE_TAG"
              git commit -m "$COMMIT_MSG"
              git push
              
              # Get commit info
              COMMIT_SHA=$(git rev-parse HEAD)
              COMMIT_SHORT=$(git rev-parse --short HEAD)
              
              echo "### Commit Details" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- **Message:** $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
              echo "- **SHA:** \`$COMMIT_SHORT\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Successfully pushed to ${{ inputs.gitops_repo }}" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Changes committed and pushed (${COMMIT_SHORT})"
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **GitOps manifest update completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "**Completed:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY